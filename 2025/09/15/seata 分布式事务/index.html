<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>seata 分布式事务 | Orange's_Blog</title><meta name="author" content="Orange"><meta name="copyright" content="Orange"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="事务回顾  概述: 就是由多个操作组成的一个逻辑单元，组成这个逻辑单元的多个操作要么都成功要么都失败。  ACID四大特性 A：原子性(Atomicity) 一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前 的状态，就像这个事务从来没有执行过一样。 C：一致性(Consisten">
<meta property="og:type" content="article">
<meta property="og:title" content="seata 分布式事务">
<meta property="og:url" content="http://www.zorange.online/2025/09/15/seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/index.html">
<meta property="og:site_name" content="Orange&#39;s_Blog">
<meta property="og:description" content="事务回顾  概述: 就是由多个操作组成的一个逻辑单元，组成这个逻辑单元的多个操作要么都成功要么都失败。  ACID四大特性 A：原子性(Atomicity) 一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前 的状态，就像这个事务从来没有执行过一样。 C：一致性(Consisten">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg">
<meta property="article:published_time" content="2025-09-15T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-23T09:10:12.132Z">
<meta property="article:author" content="Orange">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg"><link rel="shortcut icon" href="https://raw.githubusercontent.com/OrangeZSW/blog_img/preview.jpg"><link rel="canonical" href="http://www.zorange.online/2025/09/15/seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'seata 分布式事务',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-23 17:10:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><link rel="stylesheet" href="/css/message.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-book"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-heartbeat"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-camera"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/cloud/"><i class="fa-fw fas fa-cloud"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fas fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Orange's_Blog"><img class="site-icon" src="http://oss.zorange.online/blog/logo.png"/><span class="site-name">Orange's_Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-book"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-heartbeat"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-camera"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/cloud/"><i class="fa-fw fas fa-cloud"></i><span> 网盘</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/message/"><i class="fa-fw fas fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">seata 分布式事务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-15T16:00:00.000Z" title="发表于 2025-09-16 00:00:00">2025-09-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-23T09:10:12.132Z" title="更新于 2025-09-23 17:10:12">2025-09-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2025/09/15/seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" data-flag-title="seata 分布式事务"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>事务回顾</h1>
<ul>
<li>概述: 就是由多个操作组成的一个逻辑单元，组成这个逻辑单元的多个操作要么都成功要么都失败。</li>
</ul>
<h2 id="ACID四大特性">ACID四大特性</h2>
<p><strong>A：原子性(Atomicity)</strong></p>
<p>一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前</p>
<p>的状态，就像这个事务从来没有执行过一样。</p>
<p><strong>C：一致性(Consistency)</strong></p>
<p>事务的一致性指的是在一个事务执行之前和执行之后数据库都必须处于一致性状态。</p>
<p>如果事务成功地完成，那么系统中所有变化将正确地应用，系统处于有效状态。</p>
<p>如果在事务中出现错误，那么系统中的所有变化将自动地回滚，系统返回到原始状态。</p>
<p><strong>I：隔离性(Isolation)</strong></p>
<p>指的是在并发环境中，当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间。由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。事务查看</p>
<p>数据更新时，数据所处的状态要么是另一事务修改它之前的状态，要么是另一事务修改它之后的状态，事务不会查看到中间状态的数据。</p>
<p><strong>D：持久性(Durability)</strong></p>
<p>指的是只要事务成功结束，它对数据库所做的更新就必须保存下来。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。</p>
<h2 id="事务的并发问题">事务的并发问题</h2>
<p><strong>脏读</strong>：事务A读取了事务B更新的数据，事务B未提交并回滚数据，那么A读取到的数据是脏数据</p>
<p><strong>不可重复读</strong>：事务A多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果不一致。</p>
<p><strong>幻读</strong>：一个事务读取到了另外一个事务插入的数据，就好像发生了幻觉一样，这就叫幻读。</p>
<p><strong>小结</strong>：不可重复读的和幻读很容易混淆，不可重复读侧重于修改，幻读侧重于新增或删除。</p>
<h2 id="事务隔离级别">事务隔离级别</h2>
<p>针对并发事务所带来的问题，要想解决就需要使用到事务的隔离级别。</p>
<p>常见的事务隔离级别和解决的问题的对应关系表如下所示：<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/70e8222c4c5185cf2cae6a9436219e32.png" alt=""></p>
<h2 id="事务传播行为">事务传播行为</h2>
<ul>
<li><strong>概述</strong>：指的就是当一个方法被另一个方法调用时，这个方法对事务的态度。</li>
</ul>
<p>Spring定义了七种传播行为：<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/b8355de5ce618d4071211f66780424ab.png" alt=""></p>
<h1>分布式事务概述</h1>
<h2 id="本地事务">本地事务</h2>
<ul>
<li>称为数据库事务或传统事务（相对于分布式事务而言）。这一类事务是基于单个服务单一数据库访问的事务。</li>
</ul>
<h2 id="分布式事务简介">分布式事务简介</h2>
<ul>
<li>概述：分布式事务指的是组成业务逻辑单元的多个操作位于不同的服务上或者访问不同的数据库节点，分布式事务需要保证这些操作要么全部成功，要么全部失败。</li>
</ul>
<h1>理论基础</h1>
<h2 id="CAP定理">CAP定理</h2>
<p>1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。</p>
<p>1、Consistency（一致性）</p>
<p>2、Availability（可用性）</p>
<p>3、Partition tolerance （分区容错性）</p>
<p>它们的第一个字母分别是 C、A、P。</p>
<p>Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p>
<h3 id="一致性">一致性</h3>
<p>Consistency（一致性）：用户访问分布式系统中的任意节点，得到的数据必须一致。</p>
<h3 id="可用性">可用性</h3>
<p>Availability （可用性）：用户访问集群中的任意健康节点，必须能得到响应，而不是超时或拒绝。</p>
<h3 id="分区容错">分区容错</h3>
<p>因为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区。</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/6eee135715558706fc80fe9a8f2765db.png" alt=""></p>
<ul>
<li>Tolerance（容错）：在集群出现分区时，整个系统也要持续对外提供服务</li>
</ul>
<p>在分布式系统中，系统间的网络不能100%保证健康，一定会有故障的时候，而服务有必须对外保证服务。因此Partition Tolerance不可避免。当节点接收到新的数据变更时，就会出现问题了：</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/b3fef90f191b4db5800b1c0b026de78d.png" alt=""></p>
<ul>
<li>
<p>如果此时要保证一致性，就必须等待网络恢复，完成数据同步后，整个集群才对外提供服务，服务处于阻塞状态，不可用。</p>
</li>
<li>
<p>如果此时要保证可用性，就不能等待网络恢复，那node01、node02与node03之间就会出现数据不一致。</p>
</li>
</ul>
<p>也就是说，在P一定会出现的情况下，A和C之间只能实现一个。</p>
<p>注意：在CAP定理中一致性强调的是强一致性</p>
<h2 id="BASE理论">BASE理论</h2>
<p>BASE理论是对CAP的一种解决思路，包含三个思想：</p>
<p>1、Basically Available （基本可用）：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。</p>
<p>2、Soft State（软状态）：在一定时间内，允许出现中间状态，比如临时的不一致状态。</p>
<p>3、Eventually Consistent（最终一致性）：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。</p>
<h1>Seata</h1>
<h2 id="Seata简介">Seata简介</h2>
<p>Seata是 2019 年 1 月份蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案。致力于提供高性能和简单易用的分布式事务服务，为用户打造一站式的分布式解决方案。</p>
<p>官网地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://seata.io/zh-cn/%EF%BC%8C%E5%85%B6%E4%B8%AD%E7%9A%84%E6%96%87%E6%A1%A3%E3%80%81%E6%92%AD%E5%AE%A2%E4%B8%AD%E6%8F%90%E4%BE%9B%E4%BA%86%E5%A4%A7%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%82">https://seata.io/zh-cn/，其中的文档、播客中提供了大量的使用说明、源码分析。</a></p>
<h2 id="Seata架构">Seata架构</h2>
<ul>
<li>
<p>基础概念：</p>
<ul>
<li>
<p>分支事务：每一个业务系统的事务</p>
</li>
<li>
<p>全局事务：多个有关联的各个分支事务组成在一起</p>
</li>
</ul>
</li>
</ul>
<p><strong>Seata事务管理中有三个重要的角色：</strong></p>
<ul>
<li>
<p>1、TC (Transaction Coordinator) - 事务协调者：维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
</li>
<li>
<p>2、TM (Transaction Manager) - 事务管理器：定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
</li>
<li>
<p>3、RM (Resource Manager) - 资源管理器：管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
</li>
</ul>
<p>工作流程如下图所示：</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/68e4364165e0e1e70eb84c2cc5b2dac2.png" alt=""></p>
<p>基本流程介绍：</p>
<p>1、由TM注册全局事务到TC服务器</p>
<p>2、TC服务器会返回xid(本次全局事务的id)，这个xid会随着微服务的调用一并传递下去</p>
<p>3、执行分支事务，此时就需要通过RM服务器注册分支事务到TC服务器</p>
<p>4、执行业务SQL，并有RM服务器报告每一个分支事务的执行状态到TC服务器</p>
<p>5、当全局事务结束以后，TC会进行分支事务状态的统计，然后在通过RM服务器进行分支事务的回滚或者提交</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/d8cb491b07849f9c074b9297a20d511e.png" alt=""></p>
<h3 id="四种不同的分布式事务解决方案：">四种不同的分布式事务解决方案：</h3>
<p>1、XA模式：强一致性分阶段事务模式，牺牲了一定的可用性，无业务侵入</p>
<p>2、AT模式：最终一致的分阶段事务模式，无业务侵入，也是Seata的默认模式</p>
<p>3、TCC模式：最终一致的分阶段事务模式，有业务侵入</p>
<p>4、SAGA模式：长事务模式，有业务侵入</p>
<p>无论哪种方案，都离不开TC，也就是事务的协调者。</p>
<h3 id="解决分布式事务的思想和模型：">解决分布式事务的思想和模型：</h3>
<ul>
<li>
<p>全局事务：整个分布式事务</p>
</li>
<li>
<p>分支事务：分布式事务中包含的每个子系统的事务</p>
</li>
<li>
<p>最终一致思想：各分支事务分别执行并提交，如果有不一致的情况，再想办法恢复数据</p>
</li>
<li>
<p>强一致思想：各分支事务执行完业务不要提交，等待彼此结果。而启统一提交或回滚</p>
</li>
</ul>
<h2 id="Seata-配置">Seata 配置</h2>
<h3 id="1-修改seata-的配置文件">1. 修改seata 的配置文件</h3>
<p>这个TC服务在运行的时候需要一些配置信息，我们可以将这些配置信息交由Nacos进行统一管理。并且需要将TC服务注册到Nacos，后期微服务就可以从Nacos中获取TC服务器的地址信息完成事务的控制。</p>
<ul>
<li>config/application.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置seata后台管理系统的访问用户名和密码</span></span><br><span class="line">  <span class="attr">console:</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">seata</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">seata</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="comment"># support: nacos, consul, apollo, zk, etcd3</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.136</span><span class="number">.145</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">context-path:</span></span><br><span class="line">      <span class="attr">data-id:</span> <span class="string">seataServer.properties</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.136</span><span class="number">.145</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">      <span class="attr">context-path:</span></span><br><span class="line">  <span class="comment">#store:</span></span><br><span class="line">    <span class="comment"># support: file 、 db 、 redis 、 raft</span></span><br><span class="line">    <span class="comment"># mode: file</span></span><br><span class="line">  <span class="comment">#  server:</span></span><br><span class="line">  <span class="comment">#    service-port: 8091 #If not configured, the default is &#x27;$&#123;server.port&#125; + 1000&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-为seata配置-nacos配置中心">2.  为seata配置,(nacos配置中心)</h3>
<p>在Nacos中添加TC服务所需要的配置文件seataServer.properties。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">#For details about configuration items, see https://seata.io/zh-cn/docs/user/configurations.html</span><br><span class="line">#Transport configuration, for client and server</span><br><span class="line">transport.type=TCP</span><br><span class="line">transport.server=NIO</span><br><span class="line">transport.heartbeat=true</span><br><span class="line">transport.enableTmClientBatchSendRequest=false</span><br><span class="line">transport.enableRmClientBatchSendRequest=true</span><br><span class="line">transport.enableTcServerBatchSendResponse=false</span><br><span class="line">transport.rpcRmRequestTimeout=30000</span><br><span class="line">transport.rpcTmRequestTimeout=30000</span><br><span class="line">transport.rpcTcRequestTimeout=30000</span><br><span class="line">transport.threadFactory.bossThreadPrefix=NettyBoss</span><br><span class="line">transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker</span><br><span class="line">transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler</span><br><span class="line">transport.threadFactory.shareBossWorker=false</span><br><span class="line">transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector</span><br><span class="line">transport.threadFactory.clientSelectorThreadSize=1</span><br><span class="line">transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread</span><br><span class="line">transport.threadFactory.bossThreadSize=1</span><br><span class="line">transport.threadFactory.workerThreadSize=default</span><br><span class="line">transport.shutdown.wait=3</span><br><span class="line">transport.serialization=seata</span><br><span class="line">transport.compressor=none</span><br><span class="line"></span><br><span class="line"># 首先应用程序（客户端）中配置了事务分组，若应用程序是SpringBoot则通过配置seata.tx-service-group=[事务分组配置项]</span><br><span class="line"># 事务群组，service.vgroupMapping.[事务分组配置项]=TC集群的名称</span><br><span class="line">service.vgroupMapping.default_tx_group=default</span><br><span class="line">#If you use a registry, you can ignore it</span><br><span class="line">service.default.grouplist=127.0.0.1:8091</span><br><span class="line">service.enableDegrade=false</span><br><span class="line">service.disableGlobalTransaction=false</span><br><span class="line"></span><br><span class="line">client.metadataMaxAgeMs=30000</span><br><span class="line">#Transaction rule configuration, only for the client</span><br><span class="line">client.rm.asyncCommitBufferLimit=10000</span><br><span class="line">client.rm.lock.retryInterval=10</span><br><span class="line">client.rm.lock.retryTimes=30</span><br><span class="line">client.rm.lock.retryPolicyBranchRollbackOnConflict=true</span><br><span class="line">client.rm.reportRetryCount=5</span><br><span class="line">client.rm.tableMetaCheckEnable=true</span><br><span class="line">client.rm.tableMetaCheckerInterval=60000</span><br><span class="line">client.rm.sqlParserType=druid</span><br><span class="line">client.rm.reportSuccessEnable=false</span><br><span class="line">client.rm.sagaBranchRegisterEnable=false</span><br><span class="line">client.rm.sagaJsonParser=fastjson</span><br><span class="line">client.rm.tccActionInterceptorOrder=-2147482648</span><br><span class="line">client.rm.sqlParserType=druid</span><br><span class="line">client.tm.commitRetryCount=5</span><br><span class="line">client.tm.rollbackRetryCount=5</span><br><span class="line">client.tm.defaultGlobalTransactionTimeout=60000</span><br><span class="line">client.tm.degradeCheck=false</span><br><span class="line">client.tm.degradeCheckAllowTimes=10</span><br><span class="line">client.tm.degradeCheckPeriod=2000</span><br><span class="line">client.tm.interceptorOrder=-2147482648</span><br><span class="line">client.undo.dataValidation=true</span><br><span class="line">client.undo.logSerialization=jackson</span><br><span class="line">client.undo.onlyCareUpdateColumns=true</span><br><span class="line">server.undo.logSaveDays=7</span><br><span class="line">server.undo.logDeletePeriod=86400000</span><br><span class="line">client.undo.logTable=undo_log</span><br><span class="line">client.undo.compress.enable=true</span><br><span class="line">client.undo.compress.type=zip</span><br><span class="line">client.undo.compress.threshold=64k</span><br><span class="line">#For TCC transaction mode</span><br><span class="line">tcc.fence.logTableName=tcc_fence_log</span><br><span class="line">tcc.fence.cleanPeriod=1h</span><br><span class="line"># You can choose from the following options: fastjson, jackson, gson</span><br><span class="line">tcc.contextJsonParserType=fastjson</span><br><span class="line"></span><br><span class="line">#Log rule configuration, for client and server</span><br><span class="line">log.exceptionRate=100</span><br><span class="line"></span><br><span class="line">#事务会话信息存储方式</span><br><span class="line">#Transaction storage configuration, only for the server. The file, db, and redis configuration values are optional.</span><br><span class="line">store.mode=db</span><br><span class="line">#事务锁信息存储方式</span><br><span class="line">store.lock.mode=db</span><br><span class="line">#事务回话信息存储方式</span><br><span class="line">store.session.mode=db</span><br><span class="line">#Used for password encryption</span><br><span class="line">store.publicKey=</span><br><span class="line"></span><br><span class="line">#If `store.mode,store.lock.mode,store.session.mode` are not equal to `file`, you can remove the configuration block.</span><br><span class="line">store.file.dir=file_store/data</span><br><span class="line">store.file.maxBranchSessionSize=16384</span><br><span class="line">store.file.maxGlobalSessionSize=512</span><br><span class="line">store.file.fileWriteBufferCacheSize=16384</span><br><span class="line">store.file.flushDiskMode=async</span><br><span class="line">store.file.sessionReloadReadSize=100</span><br><span class="line"></span><br><span class="line">#存储方式为db</span><br><span class="line">#These configurations are required if the `store mode` is `db`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `db`, you can remove the configuration block.</span><br><span class="line">store.db.datasource=druid</span><br><span class="line">store.db.dbType=mysql</span><br><span class="line">store.db.driverClassName=com.mysql.cj.jdbc.Driver</span><br><span class="line">store.db.url=jdbc:mysql://192.168.136.145:3308/seata?useUnicode=true&amp;rewriteBatchedStatements=true&amp;useSSL=false</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=1234</span><br><span class="line">store.db.minConn=5</span><br><span class="line">store.db.maxConn=30</span><br><span class="line">store.db.globalTable=global_table</span><br><span class="line">store.db.branchTable=branch_table</span><br><span class="line">store.db.distributedLockTable=distributed_lock</span><br><span class="line">store.db.queryLimit=100</span><br><span class="line">store.db.lockTable=lock_table</span><br><span class="line">store.db.maxWait=5000</span><br><span class="line"></span><br><span class="line">#These configurations are required if the `store mode` is `redis`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `redis`, you can remove the configuration block.</span><br><span class="line">store.redis.mode=single</span><br><span class="line">store.redis.type=pipeline</span><br><span class="line">store.redis.single.host=127.0.0.1</span><br><span class="line">store.redis.single.port=6379</span><br><span class="line">store.redis.sentinel.masterName=</span><br><span class="line">store.redis.sentinel.sentinelHosts=</span><br><span class="line">store.redis.sentinel.sentinelPassword=</span><br><span class="line">store.redis.maxConn=10</span><br><span class="line">store.redis.minConn=1</span><br><span class="line">store.redis.maxTotal=100</span><br><span class="line">store.redis.database=0</span><br><span class="line">store.redis.password=</span><br><span class="line">store.redis.queryLimit=100</span><br><span class="line"></span><br><span class="line">#Transaction rule configuration, only for the server</span><br><span class="line">server.recovery.committingRetryPeriod=1000</span><br><span class="line">server.recovery.asynCommittingRetryPeriod=1000</span><br><span class="line">server.recovery.rollbackingRetryPeriod=1000</span><br><span class="line">server.recovery.timeoutRetryPeriod=1000</span><br><span class="line">server.maxCommitRetryTimeout=-1</span><br><span class="line">server.maxRollbackRetryTimeout=-1</span><br><span class="line">server.rollbackRetryTimeoutUnlockEnable=false</span><br><span class="line">server.distributedLockExpireTime=10000</span><br><span class="line">server.session.branchAsyncQueueSize=5000</span><br><span class="line">server.session.enableBranchAsyncRemove=false</span><br><span class="line">server.enableParallelRequestHandle=true</span><br><span class="line">server.enableParallelHandleBranch=false</span><br><span class="line"></span><br><span class="line">server.raft.cluster=127.0.0.1:7091,127.0.0.1:7092,127.0.0.1:7093</span><br><span class="line">server.raft.snapshotInterval=600</span><br><span class="line">server.raft.applyBatch=32</span><br><span class="line">server.raft.maxAppendBufferSize=262144</span><br><span class="line">server.raft.maxReplicatorInflightMsgs=256</span><br><span class="line">server.raft.disruptorBufferSize=16384</span><br><span class="line">server.raft.electionTimeoutMs=2000</span><br><span class="line">server.raft.reporterEnabled=false</span><br><span class="line">server.raft.reporterInitialDelay=60</span><br><span class="line">server.raft.serialization=jackson</span><br><span class="line">server.raft.compressor=none</span><br><span class="line">server.raft.sync=true</span><br><span class="line"></span><br><span class="line">#Metrics configuration, only for the server</span><br><span class="line">metrics.enabled=false</span><br><span class="line">metrics.registryType=compact</span><br><span class="line">metrics.exporterList=prometheus</span><br><span class="line">metrics.exporterPrometheusPort=9898</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>1、其中的数据库地址、用户名、密码都需要修改成你自己的数据库信息</p>
<p>2、添加useSSL=false参数，关闭安全链接</p>
<p>3、如果使用的是mysql8，需要指定mysql8的驱动：com.mysql.cj.jdbc.Driver</p>
<p>4、注意jdk版本是8或者11，其他的jdk版本可能导致出现问题<br>
5、创建数据库表</p>
<blockquote>
<p>特别注意：tc服务在管理分布式事务时，需要记录事务相关数据到数据库中，你需要提前创建好这些表。<br>
新建一个名为seata的数据库，运行script\server\db\mysql.sql脚本文件。</p>
</blockquote>
<ul>
<li>启动seata:<br>
打开浏览器，访问seata后台管理系统。地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:7091">http://localhost:7091</a>，用户名/密码: seata/seata</li>
</ul>
<h3 id="3-引入依赖">3. 引入依赖</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Seata依赖  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--使用2.0.0的seata的版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-添加公共配置">4. 添加公共配置</h3>
<ul>
<li>在nacos配置中心上添加seata的tc服务的公共配置：data-id=seata-common.yaml   group=SEATA_GROUP</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="comment"># 配置seata-server在nacos注册中心上的信息</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">namespace:</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">192.168</span><span class="number">.136</span><span class="number">.145</span><span class="string">:8848</span></span><br><span class="line">  <span class="comment"># 配置事务组的名称，需要和seata服务端的配置保持一致</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">default_tx_group</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">      <span class="attr">default_tx_group:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">data-source-proxy-mode:</span> <span class="string">XA</span>   <span class="comment"># 配置事务管理模式为xa模式</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.nacos.config.shared-configs[0].data-id=seata-common.yaml</span><br><span class="line">spring.cloud.nacos.config.shared-configs[0].group=SEATA_GROUP</span><br></pre></td></tr></table></figure>
<h3 id="5-使用">5. 使用</h3>
<p>@GlobalTransactional<br>
在BusinessServiceImpl的add方法上添加@GlobalTransactional注解，声明当前方法是一个全局事务方法。</p>
<h1>XA原理</h1>
<p>XA规范是X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准。</p>
<p>XA规范描述了全局的事务管理器与局部的资源管理器之间的接口。 XA规范的目的是允许的多个资源（如数据库，应用服务器，消息队列等）在同一事务中访问，这样可以使</p>
<p>ACID属性跨越应用程序而保持有效。</p>
<p>XA规范使用两阶段提交（2PC，Two-Phase Commit）来保证所有资源同时提交或回滚任何特定的事务。</p>
<p>XA规范在上世纪 90 年代初就被提出。目前，几乎所有主流的数据库(MySQL、Oracle)都对 XA 规范 提供了支持。</p>
<h2 id="工作原理">工作原理</h2>
<p>在 Seata 定义的分布式事务框架内，利用事务资源（数据库、消息服务等）对XA协议的支持，以XA协议的机制来管理分支事务的一种事务模式。<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/098e4a093965a9b27dbf05d93e38201e.png" alt=""></p>
<ul>
<li>工作流程如下所示：</li>
</ul>
<p><strong>RM一阶段的工作</strong>：</p>
<p>1、注册分支事务到TC</p>
<p>2、执行分支业务sql但不提交</p>
<p>3、报告执行状态到TC</p>
<p><strong>TC二阶段的工作</strong>：TC检测各分支事务执行状态</p>
<p>a.如果都成功，通知所有RM提交事务</p>
<p>b.如果有失败，通知所有RM回滚事务</p>
<p><strong>RM二阶段的工作</strong>：接收TC指令，提交或回滚事务</p>
<ul>
<li>
<p>正常情况：<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/4bd77fdbe3836562005674bbb6f94427.png" alt=""></p>
</li>
<li>
<p>异常情况：<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/9e20a6800eaf8f7b03337a042e66a3cc.png" alt=""></p>
</li>
</ul>
<h2 id="优缺点">优缺点</h2>
<ul>
<li>XA模式的优点是什么？</li>
</ul>
<p>1、业务无侵入：和 AT 一样，XA 模式将是业务无侵入的，不给应用设计和开发带来额外负担。</p>
<p>2、事务的强一致性，满足ACID原则。</p>
<p>3、数据库的支持广泛：XA 协议被主流关系型数据库广泛支持，不需要额外的适配即可使用。</p>
<ul>
<li>XA模式的缺点是什么？</li>
</ul>
<p>XA prepare后，分支事务进入阻塞阶段，收到XA commit 或 XA rollback 前必须阻塞等待。事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，性能差。</p>
<h1>AT模式</h1>
<p>更改nacos中seata-common.yaml的配置，如下所示：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line"><span class="attr">data-source-proxy-mode:</span> <span class="string">AT</span>          <span class="comment"># 使用Seata框架的AT模式，默认是AT模式</span></span><br></pre></td></tr></table></figure>
<p>重启服务进行测试。</p>
<h2 id="原理介绍">原理介绍</h2>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/883e33edda608618b89a9a8614d808fd.png" alt=""></p>
<ul>
<li>工作流程如下所示：</li>
</ul>
<p><strong>阶段一RM的工作：</strong></p>
<p>1、注册分支事务</p>
<p>2、记录undo-log（数据快照：记录某一时刻数据的状态）</p>
<p>3、执行业务sql并提交</p>
<p>4、报告事务状态</p>
<p><strong>阶段二提交时RM的工作</strong>：删除undo-log即可</p>
<p><strong>阶段二回滚时RM的工作</strong>：根据undo-log恢复数据到更新前</p>
<h2 id="流程梳理">流程梳理</h2>
<p>AT模式下，当前分支事务执行流程如下：</p>
<h3 id="一阶段：">一阶段：</h3>
<p>1）TM发起并注册全局事务到TC</p>
<p>2）TM调用分支事务</p>
<p>3）分支事务准备执行业务SQL</p>
<p>4）RM拦截业务SQL，根据where条件查询原始数据，形成快照。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;money&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>5）RM执行业务SQL，提交本地事务，释放数据库锁。此时 money = 90</p>
<p>6）RM报告本地事务状态给TC</p>
<h3 id="二阶段：">二阶段：</h3>
<p>1）TM通知TC事务结束</p>
<p>2）TC检查分支事务状态</p>
<p>2.1 如果都成功，则立即删除快照</p>
<p>2.2 如果有分支事务失败，需要回滚。读取快照数据（{“id”: 1, “money”: 100}），将快照恢复到数据库。此时数据库再次恢复为100</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/a434854772308504fab555287337eb29.png" alt=""></p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/d5ee70dc3dec24d1a2ffdaaa63ecb242.png" alt=""></p>
<h2 id="AT与XA的区别">AT与XA的区别</h2>
<p>简述AT模式与XA模式最大的区别是什么？</p>
<p>1、XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。</p>
<p>2、XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。(undo_log表(快照))</p>
<p>3、XA模式强一致；AT模式最终一致</p>
<h2 id="脏写问题">脏写问题</h2>
<h3 id="问题介绍">问题介绍</h3>
<p>在多线程并发访问AT模式的分布式事务时，有可能出现丢失更新问题，如图：</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/1f43a45b40f83b2146fae8e97e9b4bc7.png" alt=""></p>
<h3 id="全局锁">全局锁</h3>
<p>解决思路就是引入了全局锁的概念。在释放DB锁之前，先拿到全局锁。避免同一时刻有另外一个事务来操作当前数据。</p>
<p>如下图所示：</p>
<p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 全局锁 ，本地提交释放本地锁。 tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 全局锁 ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 全局锁 。</p>
<p>tx1 二阶段全局提交，释放 全局锁 。tx2 拿到 全局锁 提交本地事务。</p>
<p>如果 tx1 的二阶段全局回滚，则tx1需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。此时，如果tx2仍在等待该数据的 全局锁，同时持有本地锁，则tx1的分支回滚会失败。分支的回滚会一直重试，直到tx2的 全局锁 等锁超时，放弃 全局锁 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。</p>
<p>为整个过程 全局锁 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 脏写 的问题。</p>
<p>思考问题：每一个微服务中所提供的undo_log表的作用、以及seata数据库中所对应的表的作用分表是什么?</p>
<h1>TCC模式</h1>
<h2 id="TCC模式概述">TCC模式概述</h2>
<p>TCC模式与AT模式非常相似，每阶段都是独立事务，不同的是TCC通过<strong>人工编码</strong>来实现数据恢复。需要实现三个方法：</p>
<p>1、Try：资源的检测和预留；</p>
<p>2、Confirm：完成资源操作业务；要求 Try 成功 Confirm 一定要能成功。</p>
<p>3、Cancel：预留资源释放，可以理解为try的反向操作。</p>
<h2 id="流程分析">流程分析</h2>
<p>举例，一个扣减用户余额的业务。假设账户A原来余额是100，需要余额扣减30元。</p>
<p><strong>阶段一（ Try ）</strong>：检查余额是否充足，如果充足则冻结金额增加30元，可用余额扣除30</p>
<p>初识余额：<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/bfcf35531d2f9f6ccb02e133b7d776c1.png" alt=""></p>
<p>余额充足，可以冻结：<br>
<img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/6431cfac8b9f19d26b8230bd0fe0a9b8.png" alt=""></p>
<p>此时，总金额 = 冻结金额 + 可用金额，数量依然是100不变。事务直接提交无需等待其它事务。</p>
<p><strong>阶段二（Confirm)</strong>：假如要提交（Confirm），则冻结金额扣减30</p>
<p>确认可以提交，不过之前可用金额已经扣减过了，这里只要清除冻结金额就好了：</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/751ecd147e82aef38e0a52ff7914a1a8.png" alt=""></p>
<p>此时，总金额 = 冻结金额 + 可用金额 = 0 + 70  = 70元</p>
<p><strong>阶段二(Canncel)</strong>：如果要回滚（Cancel），则冻结金额扣减30，可用余额增加30</p>
<p>需要回滚，那么就要释放冻结金额，恢复可用金额：</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/301479a856a77e47521610c8dc8038d7.png" alt=""></p>
<h2 id="7-3-原理介绍">7.3 原理介绍</h2>
<p>工作模式如下图所示：</p>
<p><img src="http://120.26.79.238/minioapi/orange-blog/articleImages/1/bfa02782458a9a4ba2d677002031a441.png" alt=""></p>
<h2 id="7-4-优缺点">7.4 优缺点</h2>
<p>TCC模式的每个阶段是做什么的？</p>
<ul>
<li>Try：资源检查和预留</li>
<li>Confirm：业务执行和提交</li>
<li>Cancel：预留资源的释放</li>
</ul>
<p>TCC的优点是什么？</p>
<ul>
<li>一阶段完成直接提交事务，释放数据库资源，性能好</li>
<li>相比AT模型，无需生成快照，无需使用全局锁，<strong>性能最强</strong></li>
<li><strong>不依赖数据库事务</strong>，而是依赖补偿操作，可以用于非事务型数据库</li>
</ul>
<p>TCC的缺点是什么？</p>
<ul>
<li>有代码侵入，需要人为编写try、Confirm和Cancel接口，太麻烦</li>
<li>软状态，事务是最终一致</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.zorange.online">Orange</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.zorange.online/2025/09/15/seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">http://www.zorange.online/2025/09/15/seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.zorange.online" target="_blank">Orange's_Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/15/redis/" title="redis"><img class="cover" src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="onerror=null;src='http://oss.zorange.online/blog/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">redis</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/15/spring%20boot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86/" title="spring boot自动配置原理"><img class="cover" src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="onerror=null;src='http://oss.zorange.online/blog/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">spring boot自动配置原理</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Orange</div><div class="author-info__description">welcome to my blog!</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/OrangeZSW"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/OrangeZSW" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">事务回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ACID%E5%9B%9B%E5%A4%A7%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text">ACID四大特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">事务的并发问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.3.</span> <span class="toc-text">事务隔离级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.4.</span> <span class="toc-text">事务传播行为</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">分布式事务概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">本地事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%80%E4%BB%8B"><span class="toc-number">2.2.</span> <span class="toc-text">分布式事务简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">理论基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP%E5%AE%9A%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">CAP定理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">3.1.1.</span> <span class="toc-text">一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">3.1.2.</span> <span class="toc-text">可用性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99"><span class="toc-number">3.1.3.</span> <span class="toc-text">分区容错</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BASE%E7%90%86%E8%AE%BA"><span class="toc-number">3.2.</span> <span class="toc-text">BASE理论</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.</span> <span class="toc-text">Seata简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata%E6%9E%B6%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">Seata架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">4.2.1.</span> <span class="toc-text">四种不同的分布式事务解决方案：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%80%9D%E6%83%B3%E5%92%8C%E6%A8%A1%E5%9E%8B%EF%BC%9A"><span class="toc-number">4.2.2.</span> <span class="toc-text">解决分布式事务的思想和模型：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text">Seata 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BF%AE%E6%94%B9seata-%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.1.</span> <span class="toc-text">1. 修改seata 的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BAseata%E9%85%8D%E7%BD%AE-nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">4.3.2.</span> <span class="toc-text">2.  为seata配置,(nacos配置中心)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.3.3.</span> <span class="toc-text">3. 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%B7%BB%E5%8A%A0%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.4.</span> <span class="toc-text">4. 添加公共配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8"><span class="toc-number">4.3.5.</span> <span class="toc-text">5. 使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">XA原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">5.2.</span> <span class="toc-text">优缺点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">AT模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">原理介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">流程梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A"><span class="toc-number">6.2.1.</span> <span class="toc-text">一阶段：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9A"><span class="toc-number">6.2.2.</span> <span class="toc-text">二阶段：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AT%E4%B8%8EXA%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">6.3.</span> <span class="toc-text">AT与XA的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%84%8F%E5%86%99%E9%97%AE%E9%A2%98"><span class="toc-number">6.4.</span> <span class="toc-text">脏写问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.4.1.</span> <span class="toc-text">问题介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%94%81"><span class="toc-number">6.4.2.</span> <span class="toc-text">全局锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">TCC模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCC%E6%A8%A1%E5%BC%8F%E6%A6%82%E8%BF%B0"><span class="toc-number">7.1.</span> <span class="toc-text">TCC模式概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">7.2.</span> <span class="toc-text">流程分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.3.</span> <span class="toc-text">7.3 原理介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">7.4.</span> <span class="toc-text">7.4 优缺点</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/23/Python3%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4/" title="Python3初始化工作空间"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="this.onerror=null;this.src='http://oss.zorange.online/blog/404.jpg'" alt="Python3初始化工作空间"/></a><div class="content"><a class="title" href="/2025/09/23/Python3%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4/" title="Python3初始化工作空间">Python3初始化工作空间</a><time datetime="2025-09-23T09:10:12.131Z" title="发表于 2025-09-23 17:10:12">2025-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/23/document/" title="Python3初始化工作空间"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="this.onerror=null;this.src='http://oss.zorange.online/blog/404.jpg'" alt="Python3初始化工作空间"/></a><div class="content"><a class="title" href="/2025/09/23/document/" title="Python3初始化工作空间">Python3初始化工作空间</a><time datetime="2025-09-23T09:10:12.131Z" title="发表于 2025-09-23 17:10:12">2025-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/23/GitHub%20Pages%20+%20%E5%90%8E%E7%AB%AF%20API%20%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%8D%97/" title="GitHub Pages + 后端 API 的完整实现指南"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="this.onerror=null;this.src='http://oss.zorange.online/blog/404.jpg'" alt="GitHub Pages + 后端 API 的完整实现指南"/></a><div class="content"><a class="title" href="/2025/09/23/GitHub%20Pages%20+%20%E5%90%8E%E7%AB%AF%20API%20%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0%E6%8C%87%E5%8D%97/" title="GitHub Pages + 后端 API 的完整实现指南">GitHub Pages + 后端 API 的完整实现指南</a><time datetime="2025-09-23T09:10:12.130Z" title="发表于 2025-09-23 17:10:12">2025-09-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/15/Aop/" title="Aop"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="this.onerror=null;this.src='http://oss.zorange.online/blog/404.jpg'" alt="Aop"/></a><div class="content"><a class="title" href="/2025/09/15/Aop/" title="Aop">Aop</a><time datetime="2025-09-15T16:00:00.000Z" title="发表于 2025-09-16 00:00:00">2025-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/15/Docker%E5%AE%89%E8%A3%85/" title="Docker安装"><img src="http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg" onerror="this.onerror=null;this.src='http://oss.zorange.online/blog/404.jpg'" alt="Docker安装"/></a><div class="content"><a class="title" href="/2025/09/15/Docker%E5%AE%89%E8%A3%85/" title="Docker安装">Docker安装</a><time datetime="2025-09-15T16:00:00.000Z" title="发表于 2025-09-16 00:00:00">2025-09-16</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('http://oss.zorange.online/blog/428565553df343e6afb6b6b694e85432.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Orange</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><div>welcome to my <img src="http://oss.zorange.online/blog/爱心.png">blog</img></div><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/">鄂ICP备2022016190号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'CxT2FIJk3B7lLM8Pf1uPXYuQ-gzGzoHsz',
      appKey: 'L6p0Q1gQvYEOeDpZr5tpGabx',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>